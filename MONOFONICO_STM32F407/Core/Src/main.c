/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * <h2><center>&copy; Copyright (c) 2020 STMicroelectronics.
  * All rights reserved.</center></h2>
  *
  * This software component is licensed by ST under BSD 3-Clause license,
  * the "License"; You may not use this file except in compliance with the
  * License. You may obtain a copy of the License at:
  *                        opensource.org/licenses/BSD-3-Clause
  *
  ******************************************************************************
  */
/* USER CODE END Header */

/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "dac.h"
#include "tim.h"
#include "usart.h"
#include "gpio.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <stdlib.h> //add atoi function
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/

/* USER CODE BEGIN PV */
const unsigned long freqIncTab[] = {796254, 843601, 893765, 946911, 1003217, 1062871, 1126073, 1193033, 1263974, 1339134, 1418763, 1503127, 1592507, 1687203, 1787529, 1893821, 2006434, 2125742, 2252146, 2386065, 2527948, 2678268, 2837526, 3006254, 3185015, 3374406, 3575058, 3787642, 4012867, 4251485, 4504291, 4772130, 5055896, 5356535, 5675051, 6012507, 6370030, 6748811, 7150117, 7575285, 8025735, 8502970, 9008582, 9544261, 10111792, 10713070, 11350103, 12025015, 12740059, 13497623, 14300233, 15150569, 16051469, 17005939, 18017165, 19088521, 20223584, 21426141, 22700205, 24050030, 25480119, 26995246, 28600467, 30301139, 32102938, 34011878, 36034330, 38177043, 40447168, 42852281, 45400411, 48100060, 50960238, 53990491, 57200933, 60602278, 64205876, 68023757, 72068660, 76354085, 80894335, 85704563, 90800821, 96200119, 101920476, 107980983, 114401866, 121204555, 128411753, 136047513, 144137319, 152708170, 161788671, 171409126, 181601643, 192400238, 203840952, 215961966, 228803732, 242409110, 256823506, 272095026, 288274639, 305416341, 323577341, 342818251, 363203285, 384800477, 407681904, 431923931, 457607465, 484818220, 513647012, 544190053, 576549277, 610832681, 647154683, 685636503, 726406571, 769600953, 815363807, 863847862, 915214929, 969636441, 1027294024, 1088380105, 1153098554, 1221665363};

const unsigned long tabla_seno[] = {686,689,692,695,698,702,705,708,711,714,717,721,724,727,730,733,737,740,743,746,749,752,756,759,762,765,768,771,774,778,781,784,787,790,793,796,800,803,806,809,812,815,818,821,825,828,831,834,837,840,843,846,849,852,855,859,862,865,868,871,874,877,880,883,886,889,892,895,898,901,904,907,910,913,916,919,922,925,928,931,934,937,940,943,946,949,952,955,957,960,963,966,969,972,975,978,981,983,986,989,992,995,998,1000,1003,1006,1009,1012,1014,1017,1020,1023,1025,1028,1031,1034,1036,1039,1042,1045,1047,1050,1053,1055,1058,1061,1063,1066,1068,1071,1074,1076,1079,1081,1084,1087,1089,1092,1094,1097,1099,1102,1104,1107,1109,1112,1114,1117,1119,1122,1124,1126,1129,1131,1134,1136,1138,1141,1143,1145,1148,1150,1152,1155,1157,1159,1162,1164,1166,1168,1171,1173,1175,1177,1179,1182,1184,1186,1188,1190,1192,1194,1196,1199,1201,1203,1205,1207,1209,1211,1213,1215,1217,1219,1221,1223,1225,1227,1228,1230,1232,1234,1236,1238,1240,1242,1243,1245,1247,1249,1251,1252,1254,1256,1257,1259,1261,1263,1264,1266,1268,1269,1271,1272,1274,1276,1277,1279,1280,1282,1283,1285,1286,1288,1289,1291,1292,1293,1295,1296,1298,1299,1300,1302,1303,1304,1306,1307,1308,1310,1311,1312,1313,1314,1316,1317,1318,1319,1320,1321,1323,1324,1325,1326,1327,1328,1329,1330,1331,1332,1333,1334,1335,1336,1337,1338,1338,1339,1340,1341,1342,1343,1343,1344,1345,1346,1346,1347,1348,1349,1349,1350,1351,1351,1352,1353,1353,1354,1354,1355,1355,1356,1356,1357,1357,1358,1358,1359,1359,1360,1360,1360,1361,1361,1361,1362,1362,1362,1363,1363,1363,1363,1364,1364,1364,1364,1364,1364,1365,1365,1365,1365,1365,1365,1365,1365,1365,1365,1365,1365,1365,1365,1365,1365,1365,1364,1364,1364,1364,1364,1364,1363,1363,1363,1363,1362,1362,1362,1361,1361,1361,1360,1360,1360,1359,1359,1358,1358,1357,1357,1357,1356,1355,1355,1354,1354,1353,1353,1352,1351,1351,1350,1349,1349,1348,1347,1347,1346,1345,1344,1344,1343,1342,1341,1340,1339,1339,1338,1337,1336,1335,1334,1333,1332,1331,1330,1329,1328,1327,1326,1325,1324,1323,1322,1321,1319,1318,1317,1316,1315,1314,1312,1311,1310,1309,1307,1306,1305,1303,1302,1301,1299,1298,1297,1295,1294,1292,1291,1290,1288,1287,1285,1284,1282,1281,1279,1277,1276,1274,1273,1271,1270,1268,1266,1265,1263,1261,1260,1258,1256,1254,1253,1251,1249,1247,1246,1244,1242,1240,1238,1236,1235,1233,1231,1229,1227,1225,1223,1221,1219,1217,1215,1213,1211,1209,1207,1205,1203,1201,1199,1197,1195,1193,1191,1189,1186,1184,1182,1180,1178,1176,1173,1171,1169,1167,1164,1162,1160,1158,1155,1153,1151,1148,1146,1144,1141,1139,1137,1134,1132,1129,1127,1125,1122,1120,1117,1115,1112,1110,1107,1105,1102,1100,1097,1095,1092,1090,1087,1085,1082,1080,1077,1074,1072,1069,1066,1064,1061,1059,1056,1053,1051,1048,1045,1043,1040,1037,1034,1032,1029,1026,1023,1021,1018,1015,1012,1010,1007,1004,1001,998,995,993,990,987,984,981,978,976,973,970,967,964,961,958,955,952,949,947,944,941,938,935,932,929,926,923,920,917,914,911,908,905,902,899,896,893,890,887,884,881,878,875,872,869,865,862,859,856,853,850,847,844,841,838,835,832,828,825,822,819,816,813,810,807,803,800,797,794,791,788,785,782,778,775,772,769,766,763,759,756,753,750,747,744,740,737,734,731,728,725,721,718,715,712,709,706,702,699,696,693,690,686,683,680,677,674,671,667,664,661,658,655,652,648,645,642,639,636,632,629,626,623,620,617,613,610,607,604,601,598,594,591,588,585,582,579,576,572,569,566,563,560,557,554,551,547,544,541,538,535,532,529,526,523,520,516,513,510,507,504,501,498,495,492,489,486,483,480,477,474,471,468,465,462,459,456,453,450,447,444,441,438,435,432,429,426,423,420,417,414,411,408,405,402,400,397,394,391,388,385,382,379,377,374,371,368,365,362,360,357,354,351,349,346,343,340,337,335,332,329,327,324,321,318,316,313,310,308,305,302,300,297,295,292,289,287,284,282,279,276,274,271,269,266,264,261,259,256,254,251,249,246,244,242,239,237,234,232,230,227,225,222,220,218,215,213,211,209,206,204,202,199,197,195,193,191,188,186,184,182,180,178,175,173,171,169,167,165,163,161,159,157,155,153,151,149,147,145,143,141,139,137,135,133,131,129,128,126,124,122,120,118,117,115,113,111,110,108,106,105,103,101,100,98,96,95,93,91,90,88,87,85,84,82,81,79,78,76,75,73,72,70,69,68,66,65,64,62,61,60,58,57,56,55,53,52,51,50,48,47,46,45,44,43,42,41,39,38,37,36,35,34,33,32,31,30,30,29,28,27,26,25,24,23,23,22,21,20,19,19,18,17,17,16,15,15,14,13,13,12,11,11,10,10,9,9,8,8,7,7,6,6,6,5,5,4,4,4,3,3,3,2,2,2,2,2,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,5,5,6,6,6,7,7,8,8,9,9,10,10,11,12,12,13,13,14,15,15,16,17,17,18,19,20,20,21,22,23,24,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,48,49,50,51,52,54,55,56,57,59,60,61,63,64,65,67,68,69,71,72,74,75,77,78,80,81,83,84,86,87,89,90,92,93,95,97,98,100,102,103,105,107,108,110,112,114,115,117,119,121,123,124,126,128,130,132,134,136,137,139,141,143,145,147,149,151,153,155,157,159,161,163,165,168,170,172,174,176,178,180,182,185,187,189,191,193,196,198,200,202,205,207,209,211,214,216,218,221,223,225,228,230,233,235,237,240,242,245,247,250,252,254,257,259,262,264,267,269,272,275,277,280,282,285,287,290,293,295,298,300,303,306,308,311,314,316,319,322,325,327,330,333,335,338,341,344,346,349,352,355,358,360,363,366,369,372,374,377,380,383,386,389,392,394,397,400,403,406,409,412,415,418,421,424,427,430,432,435,438,441,444,447,450,453,456,459,462,465,468,471,474,477,480,484,487,490,493,496,499,502,505,508,511,514,517,520,523,526,530,533,536,539,542,545,548,551,554,558,561,564,567,570,573,576,580,583,586,589,592,595,598,602,605,608,611,614,617,621,624,627,630,633,636,640,643,646,649,652,655,659,662,665,668,671,675,678,681,};

uint8_t vel = 0;
volatile uint32_t note = 0;
uint32_t phase = 0;
uint16_t sample = 0;

char rx_buff[4];

uint8_t flag_rx = 0;
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DAC_Init();
  MX_TIM2_Init();
  MX_USART1_UART_Init();
  /* USER CODE BEGIN 2 */
  HAL_TIM_Base_Start_IT(&htim2);
  HAL_DAC_Start(&hdac, DAC_CHANNEL_1);
  HAL_UART_Receive_IT(&huart1, (uint8_t*) rx_buff, 4);

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
	  if (flag_rx != 0){

		  if (rx_buff[0] == 'n'){
			  note = atoi(&rx_buff[1]);
		  }

		  HAL_UART_Receive_IT(&huart1, (uint8_t*) rx_buff, 4);
		  flag_rx = 0;
	  }
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Configure the main internal regulator output voltage 
  */
  __HAL_RCC_PWR_CLK_ENABLE();
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);
  /** Initializes the CPU, AHB and APB busses clocks 
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 4;
  RCC_OscInitStruct.PLL.PLLN = 168;
  RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
  RCC_OscInitStruct.PLL.PLLQ = 7;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }
  /** Initializes the CPU, AHB and APB busses clocks 
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV4;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_5) != HAL_OK)
  {
    Error_Handler();
  }
}

/* USER CODE BEGIN 4 */
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim){
	if (htim->Instance==TIM2){
		sample = ((phase >> 20) * vel) >> 7;
		HAL_DAC_SetValue(&hdac, DAC_CHANNEL_1, DAC_ALIGN_12B_R, sample);
		phase += freqIncTab[note];
	}
}

void HAL_UART_RxCpltCallback(UART_HandleTypeDef *huart){
	flag_rx = 1;
}

/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */

  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{ 
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     tex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */

/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
